{
  "name": "PR Review System",
  "nodes": [
    {
      "parameters": {
        "owner": {
          "__rl": true,
          "value": "Kaze-nomi",
          "mode": "list",
          "cachedResultName": "Kaze-nomi",
          "cachedResultUrl": "https://github.com/Kaze-nomi"
        },
        "repository": {
          "__rl": true,
          "value": "MultiAgentIntelligentSystem",
          "mode": "list",
          "cachedResultName": "MultiAgentIntelligentSystem",
          "cachedResultUrl": "https://github.com/Kaze-nomi/MultiAgentIntelligentSystem"
        },
        "events": [
          "pull_request"
        ],
        "options": {
          "insecureSSL": false
        }
      },
      "type": "n8n-nodes-base.githubTrigger",
      "typeVersion": 1,
      "position": [
        896,
        560
      ],
      "id": "634e4c6e-619c-4020-b273-cf188f0c8f61",
      "name": "Github Trigger",
      "webhookId": "18b11740-219a-4056-8988-c29d6727a2ec",
      "credentials": {
        "githubApi": {
          "id": "fzqEA54Suh52DdCO",
          "name": "GitHub account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const webhookData = $input.first().json;\n\n// ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ñ‡Ñ‚Ğ¾ ÑÑ‚Ğ¾ PR Ğ² main Ğ²ĞµÑ‚ĞºÑƒ\nconst pr = webhookData.body.pull_request;\nif (!pr || pr.base.ref !== 'main') {\n  return [{ json: { skip: true, reason: 'Not targeting main branch' } }];\n}\n\nreturn [{\n  json: {\n    skip: false,\n    pr_number: pr.number,\n    pr_title: pr.title,\n    pr_description: pr.body || '',\n    pr_url: pr.html_url,\n    head_sha: pr.head.sha,\n    base_sha: pr.base.sha,\n    repo_owner: webhookData.body.repository.owner.login,\n    repo_name: webhookData.body.repository.name,\n    head_branch: pr.head.ref,\n    base_branch: pr.base.ref\n  }\n}];"
      },
      "id": "13c2c348-7a8e-4850-8b5d-3e4be44160e2",
      "name": "ğŸ“‹ Parse PR Data",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1104,
        560
      ]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.skip }}"
            }
          ]
        }
      },
      "id": "77096b6c-810a-4df4-8164-98db0110cd9b",
      "name": "ğŸ”€ Should Process?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        1312,
        560
      ]
    },
    {
      "parameters": {},
      "id": "c01ce50b-e5b2-4bb8-aea1-9c4ee3bbacd0",
      "name": "â­ï¸ Skipped",
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        1520,
        752
      ]
    },
    {
      "parameters": {
        "url": "=https://api.github.com/repos/{{ $json.repo_owner }}/{{ $json.repo_name }}/pulls/{{ $json.pr_number }}/files",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "githubApi",
        "options": {
          "timeout": 30000
        }
      },
      "id": "f80a44b4-38a7-4128-8c0a-b7e68dfc8474",
      "name": "ğŸ“„ Get Changed Files",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1520,
        448
      ],
      "retryOnFail": true,
      "credentials": {
        "githubApi": {
          "id": "fzqEA54Suh52DdCO",
          "name": "GitHub account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ²ÑĞµ Ñ„Ğ°Ğ¹Ğ»Ñ‹ Ğ¸Ğ· GitHub API response\nconst allFilesRaw = $input.all().map(item => item.json);\n\n// ĞĞ°Ñ…Ğ¾Ğ´Ğ¸Ğ¼ modified Ñ„Ğ°Ğ¹Ğ»Ñ‹ ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğµ Ğ½ÑƒĞ¶Ğ½Ğ¾ fetch (Ğ¿Ğ¾Ğ»Ğ½Ñ‹Ğ¹ ĞºĞ¾Ğ½Ñ‚ĞµĞ½Ñ‚)\n// Ğ”Ğ»Ñ added Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ² patch ÑĞ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ñ‚ Ğ’Ğ¡Ğ ÑĞ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ğ¼Ğ¾Ğµ\n// Ğ”Ğ»Ñ modified - Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ diff, Ğ¿Ğ¾ÑÑ‚Ğ¾Ğ¼Ñƒ Ğ½ÑƒĞ¶ĞµĞ½ Ğ¿Ğ¾Ğ»Ğ½Ñ‹Ğ¹ Ñ„Ğ°Ğ¹Ğ»\nconst modifiedFiles = allFilesRaw.filter(f => \n  f.status === 'modified' && f.contents_url\n);\n\nif (modifiedFiles.length === 0) {\n  // ĞĞµÑ‚ modified Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ² - Ğ½Ğµ Ğ½ÑƒĞ¶ĞµĞ½ fetch\n  // Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµĞ¼ dummy item Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ workflow Ğ¿Ñ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶Ğ¸Ğ»ÑÑ\n  return [{\n    json: {\n      is_dummy: true\n    }\n  }];\n}\n\n// Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµĞ¼ items Ğ´Ğ»Ñ ĞºĞ°Ğ¶Ğ´Ğ¾Ğ³Ğ¾ modified Ñ„Ğ°Ğ¹Ğ»Ğ°\n// contents_url ÑƒĞ¶Ğµ ÑĞ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ñ‚ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ñ‹Ğ¹ ref!\nreturn modifiedFiles.map(f => ({\n  json: {\n    is_dummy: false,\n    filename: f.filename,\n    contents_url: f.contents_url\n  }\n}));"
      },
      "id": "ea088dce-8f41-456c-8e50-b05f69ea1f9d",
      "name": "ğŸ“‚ Split Modified Files",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1728,
        448
      ]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.is_dummy }}"
            }
          ]
        }
      },
      "id": "ab6cc35e-7313-428a-bc87-c58ac3956f8a",
      "name": "ğŸ”€ Need Fetch?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        1936,
        448
      ]
    },
    {
      "parameters": {
        "url": "={{ $json.contents_url }}",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "githubApi",
        "options": {
          "timeout": 20000
        }
      },
      "id": "3f310981-de62-4dac-99f2-492808801f35",
      "name": "ğŸ“¥ Fetch Modified Content",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        2144,
        560
      ],
      "retryOnFail": true,
      "credentials": {
        "githubApi": {
          "id": "fzqEA54Suh52DdCO",
          "name": "GitHub account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "jsCode": "// ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ¾Ñ€Ğ¸Ğ³Ğ¸Ğ½Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¸Ğ· Ğ¿Ñ€ĞµĞ´Ñ‹Ğ´ÑƒÑ‰Ğ¸Ñ… Ğ½Ğ¾Ğ´\nconst prData = $('ğŸ“‹ Parse PR Data').first().json;\nconst allFilesRaw = $('ğŸ“„ Get Changed Files').all().map(i => i.json);\n\n// Ğ¤Ğ¾Ñ€Ğ¼Ğ¸Ñ€ÑƒĞµĞ¼ changed_files Ğ´Ğ»Ñ Project Manager\nconst changedFiles = allFilesRaw.map(f => ({\n  filename: f.filename,\n  status: f.status,\n  additions: f.additions || 0,\n  deletions: f.deletions || 0,\n  changes: f.changes || 0,\n  patch: f.patch || ''\n}));\n\n// Ğ¡Ğ¾Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ file_contents\nconst fileContents = {};\n\n// 1. Ğ¡Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ patch Ğ´Ğ»Ñ Ğ’Ğ¡Ğ•Ğ¥ Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ²\n//    Ğ”Ğ»Ñ added Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ² - ÑÑ‚Ğ¾ Ğ¿Ğ¾Ğ»Ğ½Ğ¾Ğµ ÑĞ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ğ¼Ğ¾Ğµ\n//    Ğ”Ğ»Ñ modified - ÑÑ‚Ğ¾ diff (Ğ±ÑƒĞ´ĞµÑ‚ Ğ·Ğ°Ğ¼ĞµĞ½Ñ‘Ğ½ ĞµÑĞ»Ğ¸ fetch ÑƒÑĞ¿ĞµÑˆĞµĞ½)\nfor (const file of allFilesRaw) {\n  if (file.filename && file.patch) {\n    fileContents[file.filename] = file.patch;\n  }\n}\n\n// 2. ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ input - ÑÑ‚Ğ¾ dummy Ğ¸Ğ»Ğ¸ fetched content?\nconst items = $input.all();\nconst firstItem = items[0]?.json;\nconst isDummy = firstItem?.is_dummy === true;\n\n// 3. Ğ•ÑĞ»Ğ¸ Ğ±Ñ‹Ğ» fetch - Ğ·Ğ°Ğ¼ĞµĞ½ÑĞµĞ¼ patch Ğ½Ğ° Ğ¿Ğ¾Ğ»Ğ½Ñ‹Ğ¹ ĞºĞ¾Ğ½Ñ‚ĞµĞ½Ñ‚ Ğ´Ğ»Ñ modified Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ²\nif (!isDummy) {\n  for (const item of items) {\n    const data = item.json;\n    // GitHub API Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ content (base64) Ğ¸ path\n    if (data.content && data.path) {\n      try {\n        const fullContent = Buffer.from(data.content, 'base64').toString('utf-8');\n        // ĞĞ°Ñ…Ğ¾Ğ´Ğ¸Ğ¼ ÑĞ¾Ğ¾Ñ‚Ğ²ĞµÑ‚ÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ğ¹ patch Ğ´Ğ»Ñ ÑÑ‚Ğ¾Ğ³Ğ¾ Ñ„Ğ°Ğ¹Ğ»Ğ°\n        const originalFile = allFilesRaw.find(f => f.filename === data.path);\n        const patch = originalFile?.patch || '';\n        \n        // ĞšĞ¾Ğ¼Ğ±Ğ¸Ğ½Ğ¸Ñ€ÑƒĞµĞ¼: Ğ¿Ğ¾Ğ»Ğ½Ñ‹Ğ¹ ĞºĞ¾Ğ½Ñ‚ĞµĞ½Ñ‚ + patch Ğ´Ğ»Ñ ĞºĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚Ğ° Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¹\n        fileContents[data.path] = `// === FULL FILE CONTENT ===\\n${fullContent}\\n\\n// === CHANGES (PATCH) ===\\n${patch}`;\n      } catch (e) {\n        // Ğ•ÑĞ»Ğ¸ decode failed - Ğ¾ÑÑ‚Ğ°Ğ²Ğ»ÑĞµĞ¼ patch\n        console.log('Failed to decode:', data.path, e.message);\n      }\n    }\n  }\n}\n\nreturn [{\n  json: {\n    pr_number: prData.pr_number,\n    pr_title: prData.pr_title,\n    pr_description: prData.pr_description || '',\n    pr_url: prData.pr_url,\n    repo_owner: prData.repo_owner,\n    repo_name: prData.repo_name,\n    head_branch: prData.head_branch,\n    base_branch: prData.base_branch,\n    changed_files: changedFiles,\n    file_contents: fileContents,\n    files_count: changedFiles.length\n  }\n}];"
      },
      "id": "57649cdf-9463-4a96-9534-1118d02b292b",
      "name": "ğŸ“¦ Aggregate All",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2352,
        448
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "http://project-manager:8000/review/pr",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"pr_number\": {{ $json.pr_number }},\n  \"pr_title\": {{ JSON.stringify($json.pr_title) }},\n  \"pr_description\": {{ JSON.stringify($json.pr_description || '') }},\n  \"pr_url\": {{ JSON.stringify($json.pr_url) }},\n  \"repo_owner\": {{ JSON.stringify($json.repo_owner) }},\n  \"repo_name\": {{ JSON.stringify($json.repo_name) }},\n  \"changed_files\": {{ JSON.stringify($json.changed_files || []) }},\n  \"file_contents\": {{ JSON.stringify($json.file_contents || {}) }},\n  \"head_branch\": {{ JSON.stringify($json.head_branch) }},\n  \"base_branch\": {{ JSON.stringify($json.base_branch) }}\n}",
        "options": {
          "timeout": 300000
        }
      },
      "id": "e445cbc6-cf1b-4dff-9b29-bb182a7c3981",
      "name": "ğŸ¤– Call Project Manager Review",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        2560,
        448
      ]
    },
    {
      "parameters": {
        "jsCode": "const response = $input.first().json;\n\n// Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¸Ğ· Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ° Project Manager\nconst prNumber = response.pr_number;\nconst prTitle = response.pr_title;\nconst prUrl = response.pr_url;\nconst approved = response.approved;\nconst reviewBody = response.review_body;\nconst qualityScore = response.quality_score;\nconst filesReviewed = response.files_reviewed;\n\nlet reviewEvent = 'COMMENT';\n\nreturn [{\n  json: {\n    pr_number: prNumber,\n    pr_title: prTitle,\n    pr_url: prUrl,\n    approved: approved,\n    review_event: reviewEvent,\n    review_body: reviewBody,\n    quality_score: qualityScore,\n    files_reviewed: filesReviewed,\n    message: reviewBody\n  }\n}];"
      },
      "id": "d0a0fdef-8697-407c-abba-c1176c14327f",
      "name": "ğŸ“± Format Review Message",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2768,
        448
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.github.com/repos/{{ $('ğŸ“‹ Parse PR Data').first().json.repo_owner }}/{{ $('ğŸ“‹ Parse PR Data').first().json.repo_name }}/pulls/{{ $json.pr_number }}/reviews",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "githubApi",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"body\": {{ JSON.stringify($json.review_body) }},\n  \"event\": {{ JSON.stringify($json.review_event) }}\n}",
        "options": {
          "timeout": 30000
        }
      },
      "id": "229789b7-c5af-4a3c-a2ab-7e560f05249a",
      "name": "ğŸ“ Create GitHub Review",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        2976,
        448
      ],
      "credentials": {
        "githubApi": {
          "id": "fzqEA54Suh52DdCO",
          "name": "GitHub account"
        }
      }
    },
    {
      "parameters": {},
      "id": "29523d93-3860-45f1-aa90-4e0e18bb76b1",
      "name": "âœ… End Success",
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        3184,
        448
      ]
    }
  ],
  "pinData": {},
  "connections": {
    "Github Trigger": {
      "main": [
        [
          {
            "node": "ğŸ“‹ Parse PR Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“‹ Parse PR Data": {
      "main": [
        [
          {
            "node": "ğŸ”€ Should Process?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ”€ Should Process?": {
      "main": [
        [
          {
            "node": "ğŸ“„ Get Changed Files",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "â­ï¸ Skipped",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“„ Get Changed Files": {
      "main": [
        [
          {
            "node": "ğŸ“‚ Split Modified Files",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“‚ Split Modified Files": {
      "main": [
        [
          {
            "node": "ğŸ”€ Need Fetch?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ”€ Need Fetch?": {
      "main": [
        [
          {
            "node": "ğŸ“¦ Aggregate All",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ğŸ“¥ Fetch Modified Content",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“¥ Fetch Modified Content": {
      "main": [
        [
          {
            "node": "ğŸ“¦ Aggregate All",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“¦ Aggregate All": {
      "main": [
        [
          {
            "node": "ğŸ¤– Call Project Manager Review",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ¤– Call Project Manager Review": {
      "main": [
        [
          {
            "node": "ğŸ“± Format Review Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“± Format Review Message": {
      "main": [
        [
          {
            "node": "ğŸ“ Create GitHub Review",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“ Create GitHub Review": {
      "main": [
        [
          {
            "node": "âœ… End Success",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "bd2c53d6-c6a7-43d5-85a8-7156e76c3044",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "2561db53f22c6db92d031cc7d2ea687e083305b50833ce867e949c351837dfb2"
  },
  "id": "WHTriP8t269AV7nS",
  "tags": []
}