# Справочник по коду: Модуль `domain`

Данный справочник описывает модуль `domain` проекта, который содержит модели предметной области. В настоящее время модуль включает в себя модель `Bublik` для представления данных о бубликах.

## Содержание

- [Обзор пакета `domain`](#обзор-пакета-domain)
- [Модуль `__init__.py`](#модуль-initpy)
    - [Функции](#функции)
        - [`get_domain_models()`](#get_domain_models)
- [Модуль `bublik.py`](#модуль-bublikpy)
    - [Класс `Bublik`](#класс-bublik)
        - [Атрибуты](#атрибуты)
        - [Методы](#методы)
        - [Конфигурация `Config`](#конфигурация-config)
        - [Примеры использования](#примеры-использования)
- [Модуль тестов `test_bublik.py`](#модуль-тестов-test_bublikpy)

---

## Обзор пакета `domain`

Пакет `domain` является ядром предметной области приложения. Он определяет основные сущности и бизнес-логику, не зависящую от внешних интерфейсов, таких как базы данных или API. Основным компонентом пакета является Pydantic-модель `Bublik`.

---

## Модуль `__init__.py`

Файл инициализации пакета `domain`. Он экспортирует основные модели и предоставляет метаданные о модуле для удобства использования и интроспекции.

### Функции

#### `get_domain_models()`

Возвращает словарь со всеми доступными моделями предметной области, экспортируемыми из пакета.

**Возвращает:**
- `dict[str, Any]`: Словарь, где ключи — это названия моделей, а значения — сами классы моделей.

---

## Модуль `bublik.py`

Модуль определяет доменную модель `Bublik` — сущность для представления бублика с его атрибутами и валидацией данных. Модель использует библиотеку Pydantic для обеспечения строгой типизации и проверки данных.

### Класс `Bublik`

Представляет сладкий бублик с его атрибутами. Наследуется от `pydantic.BaseModel`, что обеспечивает валидацию, сериализацию и другие полезные функции.

```python
class Bublik(BaseModel):
    # ... атрибуты и методы ...
```

#### Атрибуты

- **`id`** (`uuid.UUID`): Уникальный идентификатор бублика. Генерируется автоматически с помощью `uuid.uuid4`, если не указан явно.
- **`name`** (`str`): Название бублика. Должно быть непустой строкой длиной от 1 до 100 символов.
- **`filling`** (`str`): Тип начинки внутри бублика. Должен быть непустой строкой длиной от 1 до 50 символов.
- **`price`** (`Decimal`): Цена бублика. Должна быть положительным числом, не менее 0.01. Валидатор преобразует значение в `Decimal` для точности вычислений.
- **`is_sweet`** (`bool`): Флаг, указывающий, является ли бублик сладким. По умолчанию `True`.
- **`description`** (`str | None`): Необязательное описание бублика. Максимальная длина — 500 символов.

#### Методы

##### `validate_price(cls, v)`

**Валидатор Pydantic** для поля `price`. Проверяет, что цена является положительным числом и имеет не более двух десятичных знаков. Преобразует значение в `Decimal` для избежания ошибок с плавающей точкой.

**Параметры:**
- `v` (`Union[float, Decimal]`): Значение цены для валидации.

**Возвращает:**
- `Decimal`: Валидированное значение цены.

**Исключения:**
- `ValueError`: Если цена отрицательная, нулевая или имеет более 2 знаков после запятой.

##### `validate_strings(cls, v)`

**Валидатор Pydantic** для строковых полей (`name`, `filling`). Проверяет, что строка не является пустой или состоит только из пробелов. Приводит строку к стандартному виду (удаляет лишние пробелы и делает первую букву каждого слова заглавной).

**Параметры:**
- `v` (`str`): Строковое значение для валидации.

**Возвращает:**
- `str`: Нормализованная строка.

**Исключения:**
- `ValueError`: Если строка пустая или содержит только пробелы.

##### `get_price_with_currency(self, currency="RUB")`

Возвращает отформатированную строку с ценой и символом валюты.

**Параметры:**
- `currency` (`str`, optional): Код валюты. По умолчанию `"RUB"`. Поддерживаются `RUB`, `USD`, `EUR`.

**Возвращает:**
- `str`: Строка в формате `"Цена Символ"`, например, `"50.00 ₽"`.

##### `is_expensive(self, threshold=Decimal("100.00"))`

Проверяет, считается ли бублик дорогим, сравнивая его цену с пороговым значением.

**Параметры:**
- `threshold` (`Decimal`, optional): Пороговое значение цены. По умолчанию `Decimal("100.00")`.

**Возвращает:**
- `bool`: `True`, если цена бублика превышает порог, иначе `False`.

##### `update_price(self, new_price)`

Обновляет цену бублика, выполняя валидацию нового значения.

**Параметры:**
- `new_price` (`Union[float, Decimal, str]`): Новая цена для установки.

**Исключения:**
- `ValueError`: Если новое значение цены не проходит валидацию.

#### Конфигурация `Config`

Внутренний класс для настройки поведения модели Pydantic.

- **`json_encoders`**: Определяет, как сериализовать сложные типы в JSON. `UUID` преобразуется в строку, `Decimal` — в `float`.
- **`validate_assignment = True`**: Включает валидацию при изменении атрибутов уже созданного экземпляра.
- **`extra = "forbid"`**: Запрещает добавление полей, не объявленных в модели.
- **`schema_extra`**: Предоставляет пример данных для генерации схемы JSON (например, для OpenAPI).

#### Примеры использования

```python
import uuid
from decimal import Decimal
from src.my_project.domain import Bublik

# 1. Создание экземпляра с обязательными полями
bublik = Bublik(
    name="Шоколадная мечта",
    filling="Шоколадный крем",
    price=45.50
)

print(f"ID: {bublik.id}")
print(f"Название: {bublik.name}")
print(f"Начинка: {bublik.filling}")
print(f"Цена: {bublik.price}")  # Выведет 45.5, тип - Decimal
print(f"Сладкий? {bublik.is_sweet}")

# 2. Использование методов
price_in_rub = bublik.get_price_with_currency()
print(f"Цена в рублях: {price_in_rub}")  # Цена в рублях: 45.50 ₽

price_in_usd = bublik.get_price_with_currency("USD")
print(f"Цена в долларах: {price_in_usd}") # Цена в долларах: 45.50 $

is_it_expensive = bublik.is_expensive(threshold=Decimal("40.00"))
print(f"Дорогой ли бублик? {is_it_expensive}") # Дорогой ли бублик? True

# 3. Обновление цены
try:
    bublik.update_price(50.75)
    print(f"Новая цена: {bublik.price}") # Новая цена: 50.75
except ValueError as e:
    print(f"Ошибка обновления цены: {e}")

# 4. Пример валидации (вызовет ошибку)
try:
    invalid_bublik = Bublik(
        name="",  # Пустое имя
        filling="Варенье",
        price=-10.0 # Отрицательная цена
    )
except ValueError as e:
    print(f"Ошибка валидации: {e}")
```

---

## Модуль тестов `test_bublik.py`

Файл `tests/test_domain/test_bublik.py` содержит комплексный набор тестов для модели `Bublik`. Тесты покрывают следующие аспекты:

- **Успешное создание** экземпляров модели.
- **Валидация полей**: проверка на пустые строки, некорректную длину, отрицательную и нулевую цену.
- **Сравнение и хеширование** объектов для корректной работы в коллекциях (`set`, `dict`).
- **Сериализация и десериализация** в JSON.
- **Работа методов**: `copy()`, `copy(update=...)`, `from_orm()`.
- **Пограничные случаи**: минимальные и максимальные допустимые значения полей.

Наличие этих тестов подтверждает надежность и корректность работы модели `Bublik` в соответствии с заявленной логикой.